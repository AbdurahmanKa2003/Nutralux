 <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="images/favicon-32x32.png" type="image/x-icon" />

    <!-- SEO Meta Tags -->
    <title>Nutralux — Vitamins and Supplements Store | Buy Vitamin C, Magnesium, Zinc</title>
    <meta name="description" content="Nutralux — your reliable online store for vitamins and supplements. We offer quality products: vitamin C, magnesium, zinc, multivitamins, probiotics. Extensive catalog, detailed descriptions, fast delivery worldwide." />
    <meta name="keywords" content="Nutralux, vitamins, supplements, buy vitamins, vitamin C, magnesium, zinc, multivitamins, probiotics, health, supplement store, online vitamin store, immunity supplements, energy vitamins" />
    <meta name="author" content="Nutralux" />
    <link rel="canonical" href="https://yourwebsite.com/index.html" /> <!-- Replace with your actual website URL -->

    <!-- Open Graph Meta Tags (for social networks) -->
    <meta property="og:title" content="Nutralux — Vitamins and Supplements Store" />
    <meta property="og:description" content="Nutralux — your reliable online store for vitamins and supplements. We offer quality products: vitamin C, magnesium, zinc, multivitamins, probiotics. Extensive catalog, detailed descriptions, fast delivery worldwide." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yourwebsite.com/index.html" /> <!-- Replace with your actual website URL -->
    <meta property="og:image" content="https://yourwebsite.com/images/avatar.png" /> <!-- Replace with URL of your main image or logo -->
    <meta property="og:locale" content="en_US" />

    <!-- Twitter Card Meta Tags (for Twitter) -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Nutralux — Vitamins and Supplements Store" />
    <meta name="twitter:description" content="Nutralux — your reliable online store for vitamins and supplements. We offer quality products: vitamin C, magnesium, zinc, multivitamins, probiotics. Extensive catalog, detailed descriptions, fast delivery worldwide." />
    <meta name="twitter:image" content="https://yourwebsite.com/images/avatar.png" /> <!-- Replace with URL of your main image or logo -->

    <!-- box icons -->
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" />

    <!-- lang icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.11.0/css/flag-icons.min.css" />

    <!-- css -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Schema.org JSON-LD Markup -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Nutralux",
      "url": "https://yourwebsite.com/", <!-- Replace with your website root URL -->
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://yourwebsite.com/catalog.html?q={search_term_string}", <!-- Replace with your search URL if available -->
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Nutralux",
      "url": "https://yourwebsite.com/", <!-- Replace with your website root URL -->
      "logo": "https://yourwebsite.com/images/favicon-32x32.png", <!-- Replace with your logo URL -->
      "sameAs": [
        "https://wa.me/905332452900",
        "https://www.tiktok.com/@nutraluxlife?_t=ZS-8yvEDo3bZth&_r=1",
        "https://t.me/nutralux",
        "https://clck.ru/3NQNkm"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "+905332452900",
        "contactType": "customer service",
        "areaServed": "US"
      }
    }
    </script>
   <style>
    #chat-widget {
  position: fixed;
  bottom: 90px;
  right: 20px;
  z-index: 9999;
  display: none;
  width: 350px;
  height: 450px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
}

#chat-fab {
  position: fixed;
  bottom: 20px;
  right: 90px;
  z-index: 10000;
  display: flex;
  width: 60px;
  height: 60px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  justify-content: center;
  align-items: center;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.footer-icon-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10001;
  background: #4CAF50;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.footer-icon-top a {
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-size: 24px;
  line-height: 1;
}

.chat-messages {
  flex-grow: 1;
  padding: 10px 15px;
  overflow-y: auto;
  background-color: #f9f9f9;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.chat-input-container {
  display: flex;
  padding: 10px 15px;
  border-top: 1px solid #eee;
  background-color: #fff;
  flex-shrink: 0;
}

.chat-input-container .chat-input {
  flex-grow: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 5px 0 0 5px;
  margin-right: -1px;
  font-size: 14px;
}

.chat-input-container .chat-send {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 0 5px 5px 0;
  font-weight: bold;
  flex-shrink: 0;
}

.message {
  max-width: 80%;
  padding: 6px 10px;
  border-radius: 10px;
  word-wrap: break-word;
  font-size: 14px;
}

.bot-message {
  background-color: #e0f2f1;
  align-self: flex-start;
}

.user-message {
  background-color: #4CAF50;
  color: white;
  align-self: flex-end;
}
.chat-container {
    width: 100%;
    height: 100%; /* Занимает всю высоту родительского #chat-widget */
    display: flex;
    flex-direction: column; /* Элементы (шапка, сообщения, ввод) располагаются вертикально */
    overflow: hidden; /* Важно: предотвращает прокрутку всего виджета */
}    
@media (max-width: 600px) {
  #chat-widget {
    width: 90%;
    height: 80%;
    bottom: 80px;
    right: 5%;
    left: 5%;
    border-radius: 15px;
  }
}
.chat-messages::-webkit-scrollbar {
  width: 6px;
}
.chat-messages::-webkit-scrollbar-thumb {
  background-color: #4CAF50;
  border-radius: 3px;
}
    input, textarea, select {
  font-size: 16px !important;
}

html, body {
  overscroll-behavior: none;
  height: 100%;
}

#chat-widget {
  -webkit-transform: translateZ(0);
  position: fixed;
  bottom: 90px;
  right: 20px;
  z-index: 9999;
}

.chat-messages {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex-grow: 1;
}

@supports (-webkit-touch-callout: none) {
  #chat-widget {
    position: fixed;
    bottom: env(safe-area-inset-bottom, 90px);
  }
}
  </style>
  </head>

 <body>
    <header class="header">
        <a href="#home" class="logo">Nutralux</a>

        <i class="bx bx-menu" id="menu-icon"></i>

        <nav class="navbar">
            <a href="#about" class="active">About</a>
            <a href="#services" class="active">Services</a>
            <a href="catalog.html" class="active">Catalog</a>
            <a href="#contact" class="active">Contact</a>
            <a href="index-ru.html" class="active lang"><span class="fi fi-ru"></span></a>
        </nav>
    </header>

    <section class="home" id="home">
        <div class="home-content">
            <h1>Nutralux</h1>
            <h3>Store of <span class="multiple-text"></span></h3>
            <p>
                Vitamins and supplements for health: vitamin C, magnesium, zinc, multivitamins, probiotics and more. Quality
                formulations, clear dosage instructions, and personalized selection assistance.
            </p>
            <div class="social-media">
                <a href="https://wa.me/905332452900" target="_blank" aria-label="WhatsApp Nutralux"><i class="bx bxl-whatsapp"></i></a>
                <a href="https://www.tiktok.com/@nutraluxlife?_t=ZS-8yvEDo3bZth&_r=1" target="_blank" aria-label="TikTok Nutralux"><i class="bx bxl-tiktok"></i></a>
                <a href="https://t.me/nutralux" target="_blank" aria-label="Telegram Nutralux"><i class="bx bxl-telegram"></i></a>
                <a href="https://clck.ru/3NQNkm" target="_blank" aria-label="Instagram Nutralux"><i class="bx bxl-instagram"></i></a>
            </div>
            <a href="catalog.html" class="btn">Go to Catalog</a>
        </div>

        <div class="home-img">
            <img src="images/avatar.png" alt="Woman holding a bottle of Nutralux vitamins with green label" />
        </div>
    </section>

    <section class="about" id="about">
        <div class="about-img">
            <img src="images/about-image.png" alt="Collection of various Nutralux vitamin and supplement bottles on white background" />
        </div>

        <div class="about-content">
            <h2 class="heading">About <span>Nutralux Store</span></h2>
            <h3>Supplements and vitamins for daily support</h3>
            <p>
                We select proven supplements with clear compositions and dosages. We help choose complexes for your needs —
                immunity, energy, sleep, skin beauty, and much more.
            </p>
            <p>Focus: vitamin C, magnesium, zinc, women's multivitamins, probiotics, and basic complexes.</p>
        </div>
    </section>

    <section class="services" id="services">
        <h2 class="heading">Our <span>Nutralux Services</span></h2>

        <div class="services-container">
            <div class="services-box">
                <i class="bx bx-support"></i>
                <h3>Vitamin Selection Consultation</h3>
                <ul>
                    <li>Help with choosing formulations and dosages</li>
                    <li>Basic intake recommendations</li>
                </ul>
            </div>

            <div class="services-box">
                <i class="bx bx-package"></i>
                <h3>Fast Worldwide Delivery</h3>
                <ul>
                    <li>Same-day order shipping</li>
                    <li>Order status tracking</li>
                </ul>
            </div>

            <div class="services-box">
                <i class="bx bx-check-shield"></i>
                <h3>Quality and Supplement Transparency</h3>
                <ul>
                    <li>Only verified suppliers</li>
                    <li>Clear labels and compositions</li>
                </ul>
            </div>
        </div>
    </section>

    <section class="portfolio" id="portfolio">
        <h2 class="heading">Popular <span>Nutralux Products</span></h2>
    
        <div class="portfolio-container">
            <div class="portfolio-box">
                <div class="portfolio-img">
                    <img src="images/omega-3.jpg" alt="Nutralux Omega-3 1000 mg bottle" />
                </div>
                <div class="portfolio-content">
                    <h4>Omega-3 1000 mg</h4>
                    <p>Brain, heart, and vision support</p>
                    <a href="product.html?slug=omega-3-1000" class="btn">Learn More</a>
                </div>
            </div>
    
            <div class="portfolio-box">
                <div class="portfolio-img">
                    <img src="images/womens-multivitamin.jpg" alt="Nutralux Women's Multivitamin bottle" />
                </div>
                <div class="portfolio-content">
                    <h4>Women's Multivitamin</h4>
                    <p>Daily balance and support</p>
                    <a href="product.html?slug=womens-multivitamin" class="btn">Learn More</a>
                </div>
            </div>
        </div>
    
        <div style="text-align:center; margin-top: 1.5rem;">
            <a href="catalog.html" class="btn">View Full Catalog</a>
        </div>
    </section>
    <section class="faq" id="faq">
        <h2 class="heading">Frequently Asked <span>Questions about Nutralux</span></h2>
    
        <div class="faq-container">
            <div class="faq-item">
                <h3>How fast is delivery?</h3>
                <p>Delivery usually takes 1-2 business days. We ship orders on the same day they are placed.</p>
            </div>
    
            <div class="faq-item">
                <h3>Can children take your vitamins?</h3>
                <p>Yes, we have special complexes for children. Please check the "For Kids" section in our catalog.</p>
            </div>
    
            <div class="faq-item">
                <h3>Are there discounts for multiple items?</h3>
                <p>Yes, for orders of 3 or more items, we offer discounts and free shipping.</p>
            </div>
    
            <div class="faq-item">
                <h3>What payment methods are available?</h3>
                <p>We accept card payments, e-wallets, and cash on delivery.</p>
            </div>
        </div>
    </section>
    <footer class="footer">
        <div class="footer-text">
            <p>© 2025 Nutralux</p>
        </div>

        <div class="footer-icon-top">
            <a href="#home"><i class="bx bx-up-arrow-alt"></i></a>
        </div>
    </footer>

    <div id="chat-fab" style="display: flex;">
        <i class="bx bx-chat"></i>
    </div>

    <div id="chat-widget" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">Чат-бот Nutralux</div>
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    <strong>Бот:</strong> Здравствуйте! Я чат-бот Nutralux. Чем могу помочь?
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Напишите сообщение...">
                <button class="chat-send" id="chat-send">Отправить</button>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/scrollreveal"></script>

    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>

    <script src="script.js"></script>
    <script>
        /* to prevent Typed.js from breaking on pages without .multiple-text */
        if (typeof Typed !== 'undefined' && document.querySelector('.multiple-text')) {
            new Typed('.multiple-text', {
                strings: ['vitamins and supplements', 'daily health'],
                typeSpeed: 100,
                backSpeed: 100,
                backDelay: 1000,
                loop: true
            });
        }
<script>
    // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И СОСТОЯНИЕ ---
    let lastLanguage = 'ru';
    let currentContext = null; // Для памяти о диалоге
    let isLoading = false; // Предотвращает двойную отправку

    // --- ПРИВЯЗКА К DOM ---
    const chatWidget = document.getElementById('chat-widget');
    const chatFab = document.getElementById('chat-fab');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatMessages = document.getElementById('chat-messages');
    // Новые элементы
    const chatQuickReplies = document.getElementById('chat-quick-replies');
    const chatClear = document.getElementById('chat-clear');

    // --- ФУНКЦИЯ ДЛЯ ПЕРЕКЛЮЧЕНИЯ ЧАТА ---
    function toggleChat() {
        if (!chatWidget || !chatFab || !chatInput) {
            console.error("Элементы чата не найдены в DOM.");
            return;
        }

        const isHidden = chatWidget.style.display === 'none' || chatWidget.style.display === '';
        chatWidget.style.display = isHidden ? 'flex' : 'none';
        chatFab.innerHTML = isHidden ? '<i class="bx bx-x"></i>' : '<i class="bx bx-chat"></i>';

        if (isHidden) {
            // Загружаем историю и рендерим
            const history = loadChatHistory();
            renderChatFromHistory(history);
            
            // Если история пуста, показываем приветствие
            if (history.length === 0) {
                const welcomeMsg = getAIResponse("start_conversation", []); // Используем специальный триггер
                addMessage(welcomeMsg, 'bot');
                renderQuickReplies(['Иммунитет', 'Сон', 'Энергия']);
            }
            setTimeout(() => chatInput.focus(), 100);
        }
    }

    // --- БЕЗОПАСНАЯ ВСТАВКА HTML (САНИТАЙЗЕР) ---
    function sanitize(text) {
        const element = document.createElement('div');
        element.textContent = text;
        return element.innerHTML;
    }

    // --- ЗАГРУЗКА ДАННЫХ (СИМУЛЯЦИЯ API) ---
    async function fetchProducts() {
        // Имитируем задержку сети
        await new Promise(resolve => setTimeout(resolve, 300));

        // ДАННЫЕ ПРОДУКТОВ ТЕПЕРЬ СОДЕРЖАТ 'usage' (Способ применения)
        const products = [
            { "slug": "/product/ginkgo-biloba-500", "name": "Гинкго Билоба 500 мг", "short": "Память, внимание, кровообращение мозга", "category": "Растительные экстракты", "description": "Поддержка мозгового кровообращения и когнитивных функций: память, концентрация, координация. Снижение шума в ушах и головокружения, помощь при утомлении.", "usage": "Принимать по 1 капсуле в день во время еды. Рекомендуемый курс - 3 месяца." },
            { "slug": "/product/magnesium-b6", "name": "Магний B6", "short": "Нервная система, сон, усвоение магния", "category": "Минералы", "description": "Магний участвует во множестве обменных процессов, помогает при раздражительности, спазмах мышц и нарушениях сна. Витамин B6 поддерживает нервную систему.", "usage": "Взрослым принимать по 1-2 таблетки 2 раза в день во время еды. Продолжительность приема - 1 месяц." },
            { "slug": "/product/omega-3-1000", "name": "Омега-3 1000 мг", "short": "Мозг, сердце, зрение", "category": "Жирные кислоты", "description": "Незаменимые жирные кислоты для работы мозга и сердечно-сосудистой системы, иммунитета и состояния кожи и зрения.", "usage": "Принимать по 1 капсуле 2 раза в день во время еды. Курс приема - 1-2 месяца." },
            { "slug": "/product/b-complex", "name": "Витамин B-комплекс", "short": "Энергия, нервная система, кровь", "category": "Витамины", "description": "Комплекс витаминов группы B для энергообмена, работы ЦНС и кроветворения. Поддерживает синтез гемоглобина и обмен углеводов.", "usage": "Принимать по 1 капсуле в день утром во время еды. Продолжительность приема - 1 месяц." },
            { "slug": "/product/anti-stress", "name": "Анти-Стресс", "short": "Спокойствие, сон, снижение тревожности", "category": "Растительные экстракты", "description": "Поддержка при тревоге и напряжении, нормализация сна. Растительные экстракты зверобоя, пассифлоры и валерианы.", "usage": "Принимать по 1 капсуле 2 раза в день (утром и вечером). Для улучшения сна можно принять 2 капсулы за час до сна." },
            { "slug": "/product/vitamin-d3-10000", "name": "Витамин D3 10 000 МЕ", "short": "Иммунитет, кальциевый обмен, сосуды", "category": "Витамины", "description": "Поддерживает иммунитет и здоровый кальциевый обмен, способствует эластичности сосудов и профилактике кальцификации тканей.", "usage": "Принимать по 1 капсуле 1 раз в 2 дня утром во время еды. Рекомендуется контроль уровня 25(OH)D в крови." },
            { "slug": "/product/zinc-complex", "name": "Цинк (комплекс)", "short": "Иммунитет, кожа, обмен", "category": "Минералы", "description": "Поддержка иммунитета, кожи и обменных процессов. Усилен витамином C, D и селеном.", "usage": "Принимать по 1 таблетке в день во время еды. Рекомендуемый курс - 1 месяц." },
            { "slug": "/product/probiotic-30b", "name": "Пробиотик", "short": "Микробиом и пищеварение", "category": "Пробиотики", "description": "Мультиштаммовый пробиотик: защита от патогенов, синтез витаминов, улучшение всасывания минералов и поддержка иммунитета.", "usage": "Принимать по 1 капсуле в день, желательно натощак или перед сном. Курс - 30 дней." },
            { "slug": "/product/collagen-30-sachets", "name": "Коллаген — 30 саше", "short": "Кожа, суставы, волосы и ногти", "category": "Коллаген", "description": "Три типа коллагена + витамин C, гиалуроновая кислота, коэнзим Q10, цинк, биотин для кожи, суставов и общего тонуса.", "usage": "Растворить содержимое 1 саше в 100-150 мл воды или сока. Принимать 1 раз в день натощак, за 30 минут до еды." },
            { "slug": "/product/vitamin-c-effervescent-1000", "name": "Витамин C 1000 мг (шипучий)", "short": "Иммунитет, антиоксидант, коллаген", "category": "Витамины", "description": "Поддерживает иммунитет, состояние сосудов и кожи, улучшает усвоение железа и синтез коллагена.", "usage": "Растворить 1 шипучую таблетку в стакане воды (200 мл). Принимать 1 раз в день во время еды. Курс 10-20 дней." },
            { "slug": "/product/womens-multivitamin", "name": "Женский Мультивитамин", "short": "Ежедневный баланс, усвоение до 98%", "category": "Комплексы", "description": "Сбалансированный комплекс для женского организма: пищеварение, иммунитет, метаболизм, поддержка кожи и энергии.", "usage": "Принимать по 1 таблетке 2 раза в день (утром и днем) во время еды. Курс - 1 месяц." },
            { "slug": "/product/slimming-complex", "name": "Слимминг Комплекс", "short": "Тонус, метаболизм и контроль аппетита", "category": "Комплексы", "description": "Тонизация и поддержка снижения веса: гуарана, зелёный чай, CLA, L-карнитин, гарциния, корица, гимнема, 5-HTP и хром.", "usage": "Принимать по 2 капсулы 2 раза в день за 30 минут до еды (утром и в обед), запивая стаканом воды." }
        ];

        return products;
    }

    // --- ОБРАБОТКА ОПЕЧАТОК (без изменений) ---
    function normalizeText(text) {
        const lowerText = text.toLowerCase().trim();
        const corrections = {
            'м': 'иммунитет', 'имунитет': 'иммунитет', 'immunity': 'иммунитет', 'иммун': 'иммунитет',
            'сн': 'сон', 'спать': 'сон', 'бессонница': 'сон', 'sleep': 'сон',
            'энергия': 'энергия', 'энегия': 'энергия', 'силы': 'энергия', 'energy': 'энергия', 'усталость': 'энергия',
            'мозг': 'мозг', 'мзг': 'мозг', 'память': 'мозг', 'внимание': 'мозг', 'brain': 'мозг',
            'кожа': 'кожа', 'волосы': 'кожа', 'ногти': 'кожа', 'skin': 'кожа', 'beauty': 'кожа',
            'вес': 'вес', 'похудение': 'вес', 'диета': 'вес', 'slim': 'вес', 'похудеть': 'вес',
            'сердце': 'сердце', 'сосуды': 'сердце', 'heart': 'сердце', 'омега': 'сердце',
            'желудок': 'желудок', 'пищеварение': 'желудок', 'кишечник': 'желудок', 'digest': 'желудок', 'пробиотик': 'желудок'
        };
        
        let normalized = lowerText;
        Object.keys(corrections).forEach(wrong => {
            const regex = new RegExp(`\\b${wrong}\\b`, 'gi');
            normalized = normalized.replace(regex, corrections[wrong]);
        });
        return normalized;
    }

    // --- ОПРЕДЕЛЕНИЕ ЯЗЫКА (без изменений) ---
    function detectLanguage(text) {
        const russianChars = /[а-яё]/i;
        const englishChars = /[a-z]/i;
        const hasRu = russianChars.test(text);
        const hasEn = englishChars.test(text);
        
        if (hasRu && !hasEn) return 'ru';
        if (hasEn && !hasRu) return 'en';
        if (hasRu && hasEn) {
            const ruWords = text.match(/[а-яё]+/gi) || [];
            const enWords = text.match(/[a-z]+/gi) || [];
            return ruWords.length >= enWords.length ? 'ru' : 'en';
        }
        return lastLanguage;
    }

    // --- ЛОГИКА ИИ-ОТВЕТА (значительно переработана) ---
    function getAIResponse(message, products) {
        const normalizedMessage = normalizeText(message);
        const detectedLang = detectLanguage(message);
        lastLanguage = detectedLang;

        // --- 1. НОВЫЙ БЛОК: ПРОВЕРКА ЗАПРОСА О КОНКРЕТНОМ ПРОДУКТЕ ---
        // Это также работает как обработчик КОНТЕКСТА
        // Если бот показал "Магний B6", а юзер пишет "Магний", этот блок сработает
        
        // Упрощаем поиск: "магний b6", "магний", "пробиотик"
        const simplifiedNames = products.map(p => ({
            ...p,
            simpleName: p.name.toLowerCase().split(' ')[0].replace('(', '')
        }));

        let foundProduct = null;
        for (const p of simplifiedNames) {
            if (normalizedMessage.includes(p.name.toLowerCase()) || 
                (p.simpleName.length > 3 && normalizedMessage.includes(p.simpleName))) {
                foundProduct = p;
                break;
            }
        }
        
        // НОВЫЙ ОТВЕТ С ДЕТАЛЯМИ И ПРИМЕНЕНИЕМ
        if (foundProduct) {
            clearContext(); // Сбрасываем контекст, так как ответили на вопрос
            renderQuickReplies(['Назад к категориям', 'Что-нибудь еще?']);
            if (detectedLang === 'ru') {
                return `**Вот подробная информация о "${foundProduct.name}":**\n\n` +
                       `**Описание:** ${foundProduct.description}\n\n` +
                       `**Способ применения:** ${foundProduct.usage}`;
            } else {
                return `**Here is the detailed info for "${foundProduct.name}":**\n\n` +
                       `**Description:** ${foundProduct.description}\n\n` +
                       `**How to use:** ${foundProduct.usage}`;
            }
        }

        // --- 2. УЛУЧШЕННЫЕ СОЦИАЛЬНЫЕ ОТВЕТЫ ---
        if (/(привет|здравств|добр|хай|ку|start_conversation|hi|hello|hey|start)/.test(normalizedMessage)) {
            clearContext();
            renderQuickReplies(['Иммунитет', 'Сон', 'Энергия']);
            return detectedLang === 'ru'
                ? "Здравствуйте! 👋 Я AI-консультант Nutralux. Спросите меня о вашей цели, и я подберу идеальный комплекс.\n\nНапример: 'Что посоветуешь для сна и иммунитета?' или просто 'иммунитет'"
                : "Hello! I'm Nutralux AI consultant. Tell me your health goal and I'll find the perfect solution for you! 🇬🇧\n\nExample: 'What should I take for energy and focus?' or just 'immunity'";
        }

        const socialPatterns = {
            ru: {
                'how_are_you': /(как дела|как ты|how are you)/,
                'thanks': /(спасибо|благодарю|молодец|круто|thanks|thank you)/,
                'who_are_you': /(ты кто|кто ты|who are you)/,
                'help': /(помощь|help|что ты умееш|назад к категориям|what can you do)/
            }
        };

        if (socialPatterns.ru.how_are_you.test(normalizedMessage)) {
            clearContext();
            renderQuickReplies(['Сон', 'Иммунитет']);
            return detectedLang === 'ru' ? "Я в отличном состоянии, спасибо! Готов помочь вам выбрать лучшие добавки для **здоровья и энергии**.\n\nЧто для вас сейчас важнее: **Сон** или **Иммунитет**?" : "I'm doing great, thank you! Ready to help you find the best supplements for **health and energy**.\n\nWhat is your main priority: **Sleep** or **Immunity**?";
        }
        if (socialPatterns.ru.thanks.test(normalizedMessage)) {
            clearContext();
            renderQuickReplies(['Энергия', 'Красота']);
            return detectedLang === 'ru' ? "Пожалуйста! 🎉 Рад, что смог помочь. Если нужно что-то еще - просто спросите!\n\nМожет быть, интересует что-то для **энергии** или **красоты**?" : "You're welcome! 🎉 Glad I could help. If you need anything else - just ask!\n\nMaybe you're interested in something for **energy** or **beauty**?";
        }
        if (socialPatterns.ru.who_are_you.test(normalizedMessage)) {
            clearContext();
            renderQuickReplies(['Что тебя беспокоит?']); // Это просто пример
            return detectedLang === 'ru' ? "Я - AI-консультант Nutralux! 🤖 Помогаю подобрать идеальные витамины и добавки для ваших целей здоровья.\n\nРасскажите, что вас беспокоит?" : "I'm Nutralux AI consultant! 🤖 I help choose perfect vitamins and supplements for your health goals.\n\nTell me, what concerns you?";
        }
        if (socialPatterns.ru.help.test(normalizedMessage)) {
            clearContext();
            renderQuickReplies(['💤 Сон', '⚡ Энергия', '🛡️ Иммунитет', '💅 Красота']);
            return detectedLang === 'ru' ? "Я помогу подобрать добавки для:\n\n• 💤 **Сна и спокойствия**\n• 🧠 **Памяти и концентрации**\n• ⚡ **Энергии и тонуса**\n• 🛡️ **Иммунитета**\n• 💅 **Красоты кожи и волос**\n\nПросто напишите, что вас интересует!" : "I can help choose supplements for:\n\n• 💤 **Sleep and relaxation**\n• 🧠 **Memory and focus**\n• ⚡ **Energy and vitality**\n• 🛡️ **Immunity**\n• 💅 **Skin and hair beauty**\n\nJust tell me what interests you!";
        }

        // --- 3. ЛОГИКА ПОИСКА ПРОДУКТОВ ---
        const productMap = {
            sleep: /(сон|бессонниц|спать|засыпание|тревог|stress|sleep|insomnia)/,
            brain: /(мозг|памят|концентрац|внимание|фокус|brain|memory|focus)/,
            energy: /(энерги|сил|бодр|слабост|устал|утомлен|energy|fatigue)/,
            immunity: /(иммунит|защит|простуда|вирус|здоровье|immun|defense)/,
            beauty: /(кож|волос|ногт|красот|коллаген|skin|hair|nails|beauty)/,
            weight: /(вес|похуден|стройн|диет|метаболизм|slim|diet)/,
            heart: /(сердц|сосуд|давлен|омега|heart|pressure)/,
            stomach: /(желудок|пищевар|кишечник|пробиотик|digest|probiotic)/,
        };

        const keywordsFound = Object.keys(productMap).filter(key => productMap[key].test(normalizedMessage));

        // --- 4. СЕКЦИЯ КОМБИНАЦИЙ ---
        if (keywordsFound.length >= 2) {
            setContext({ topic: 'combination', products: [] }); // Устанавливаем контекст
            renderQuickReplies(['Спасибо!', 'Расскажи про сон']);

            if (keywordsFound.includes('sleep') && keywordsFound.includes('immunity')) {
                setContext({ topic: 'sleep-immunity', products: ['magnesium-b6', 'vitamin-d3-10000', 'zinc-complex', 'vitamin-c-effervescent-1000'] });
                return detectedLang === 'ru' ? "💤🛡️ **Для крепкого сна и сильного иммунитета:**\n\n• **Магний B6** + **Витамин D3** - идеальная пара!\n• **Цинк комплекс** - усилит защиту организма\n• **Витамин C** - поддержит в сезон простуд\n\n⭐ **Принимайте вечером:** Магний для сна, утром - D3 и Цинк для иммунитета!" : "💤🛡️ **For deep sleep and strong immunity:**\n\n• **Magnesium B6** + **Vitamin D3** - perfect combination!\n• **Zinc Complex** - boosts body defense\n• **Vitamin C** - supports during cold season\n\n⭐ **Take in evening:** Magnesium for sleep, in morning - D3 and Zinc for immunity!";
            }
            if (keywordsFound.includes('brain') && keywordsFound.includes('energy')) {
                setContext({ topic: 'brain-energy', products: ['ginkgo-biloba-500', 'omega-3-1000', 'b-complex'] });
                return detectedLang === 'ru' ? "🧠⚡ **Максимальная продуктивность и ясность ума:**\n\n• **Гинкго Билоба** - улучшает кровообращение мозга\n• **Омега-3** - питает нейроны\n• **B-комплекс** - дает энергию на весь день\n\n⭐ **Комбинация для студентов и профессионалов!**" : "🧠⚡ **Maximum productivity and mental clarity:**\n\n• **Ginkgo Biloba** - improves brain circulation\n• **Omega-3** - nourishes neurons\n• **B-Complex** - provides all-day energy\n\n⭐ **Perfect combination for students and professionals!**";
            }
        }

        // --- 5. СЕКЦИЯ ОДИНОЧНЫХ КАТЕГОРИЙ ---
        if (keywordsFound.length > 0) {
            const category = keywordsFound[0];
            let response = "";
            let productsList = [];
            let quickReplies = [];

            switch(category) {
                case 'sleep':
                    productsList = products.filter(p => p.short.includes('сон') || p.name.includes('Магний') || p.name.includes('Стресс'));
                    response = detectedLang === 'ru' ? "😴 **Для глубокого сна и спокойной нервной системы:**\n\n" : "😴 **For deep sleep and calm nervous system:**\n\n";
                    quickReplies = ['Про Магний B6', 'Про Анти-Стресс'];
                    break;
                case 'immunity':
                    productsList = products.filter(p => p.short.includes('Иммунитет') || p.name.includes('Цинк') || p.name.includes('Витамин C') || p.name.includes('Витамин D'));
                    response = detectedLang === 'ru' ? "🛡️ **Для сильного иммунитета и защиты:**\n\n" : "🛡️ **For strong immunity and protection:**\n\n";
                    quickReplies = ['Про Цинк', 'Про Витамин D3'];
                    break;
                case 'energy':
                    productsList = products.filter(p => p.short.includes('Энергия') || p.name.includes('B-комплекс') || p.name.includes('Мультивитамин'));
                    response = detectedLang === 'ru' ? "⚡ **Для энергии и жизненных сил:**\n\n" : "⚡ **For energy and vitality:**\n\n";
                    quickReplies = ['Про B-комплекс', 'Женский Мультивитамин'];
                    break;
                case 'brain':
                    productsList = products.filter(p => p.short.includes('мозг') || p.short.includes('память') || p.name.includes('Гинкго') || p.name.includes('Омега'));
                    response = detectedLang === 'ru' ? "🧠 **Для памяти и концентрации:**\n\n" : "🧠 **For memory and focus:**\n\n";
                    quickReplies = ['Про Гинкго Билоба', 'Про Омега-3'];
                    break;
                case 'beauty':
                    productsList = products.filter(p => p.short.includes('кожа') || p.name.includes('Коллаген') || p.name.includes('Цинк') || p.short.includes('волос'));
                    response = detectedLang === 'ru' ? "💅 **Для красоты кожи и волос:**\n\n" : "💅 **For skin and hair beauty:**\n\n";
                    quickReplies = ['Про Коллаген', 'Про Цинк'];
                    break;
                default:
                    productsList = [];
            }

            if (productsList.length > 0) {
                // СОЗДАЕМ ССЫЛКИ и используем САНИТАЙЗЕР
                productsList.forEach(p => {
                    response += `• <a href="${p.slug}" target="_blank"><strong>${sanitize(p.name)}</strong></a> - ${sanitize(p.short)}\n`;
                });
                
                // Добавляем совет
                const tips = { ru: { sleep: "\n💡 **Совет:** Принимайте Магний B6 за 1-2 часа до сна.", immunity: "\n💡 **Совет:** Витамины D3, C и Цинк - база в межсезонье!", energy: "\n💡 **Совет:** B-комплекс лучше принимать утром.", brain: "\n💡 **Совет:** Гинкго Билоба и Омега-3 работают лучше вместе!", beauty: "\n💡 **Совет:** Коллаген принимайте натощак." }, en: { sleep: "\n💡 **Tip:** Take Magnesium B6 1-2 hours before sleep.", immunity: "\n💡 **Tip:** Vitamins D3, C and Zinc are essential base!", energy: "\n💡 **Tip:** Take B-Complex in morning.", brain: "\n💡 **Tip:** Ginkgo Biloba and Omega-3 work better together!", beauty: "\n💡 **Tip:** Take Collagen on empty stomach." } };
                response += detectedLang === 'ru' ? (tips.ru[category] || "") : (tips.en[category] || "");
                
                // УСТАНАВЛИВАЕМ КОНТЕКСТ
                setContext({ topic: category, products: productsList.map(p => p.slug) });
                renderQuickReplies(quickReplies);
                return response;
            }
        }

        // --- 6. ОТВЕТ ПО УМОЛЧАНИЮ ---
        clearContext();
        renderQuickReplies(['Иммунитет', 'Сон', 'Энергия']);
        if (detectedLang === 'ru') {
            return "🤔 **Пожалуйста, уточните ваш запрос!**\n\nЯ специализируюсь на:\n• 💤 **Сон и расслабление**\n• 🧠 **Память и концентрация**\n• ⚡ **Энергия и тонус**\n• 🛡️ **Иммунитет и защита**\n\nНапишите, например: 'иммунитет' или 'сон и энергия'";
        } else {
            return "🤔 **Please clarify your request!**\n\nI specialize in:\n• 💤 **Sleep and relaxation**\n• 🧠 **Memory and focus**\n• ⚡ **Energy and vitality**\n• 🛡️ **Immunity and protection**\n\nWrite, for example: 'immunity' or 'sleep and energy'";
        }
    }

    // --- УПРАВЛЕНИЕ СООБЩЕНИЯМИ И ИСТОРИЕЙ ---

    // Добавляет сообщение в DOM и сохраняет в историю
    function addMessage(text, type = 'bot') {
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;

        const title = document.createElement('strong');
        if (type === 'user') {
            title.textContent = lastLanguage === 'ru' ? 'Вы: ' : 'You: ';
            // БЕЗОПАСНОСТЬ: Текст пользователя вставляем как textContent
            const content = document.createElement('span');
            content.textContent = text;
            messageDiv.appendChild(title);
            messageDiv.appendChild(content);
        } else {
            // БОТ: Ответы бота содержат HTML (ссылки, \n), поэтому используем innerHTML
            // Мы доверяем нашим шаблонам, а переменные (имена продуктов) были очищены
            title.textContent = lastLanguage === 'ru' ? 'Бот: ' : 'Bot: ';
            const content = document.createElement('span');
            content.innerHTML = text.replace(/\n/g, '<br>');
            messageDiv.appendChild(title);
            messageDiv.appendChild(content);
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Сохраняем в историю
        saveChatHistory({ text, type });
    }

    // Рендерит кнопки быстрых ответов
    function renderQuickReplies(replies = []) {
        if (!chatQuickReplies) return;
        chatQuickReplies.innerHTML = '';
        if (replies.length === 0) return;

        replies.forEach(replyText => {
            const button = document.createElement('button');
            button.textContent = replyText;
            button.addEventListener('click', () => {
                chatInput.value = replyText;
                sendMessage();
            });
            chatQuickReplies.appendChild(button);
        });
    }

    // Главная АСИНХРОННАЯ функция отправки
    async function sendMessage() {
        if (!chatInput || !chatSend || !chatMessages || isLoading) return;

        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        isLoading = true;
        addMessage(userMessage, 'user');
        chatInput.value = '';
        chatSend.disabled = true;
        renderQuickReplies([]); // Очищаем кнопки

        // Индикатор печати
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'message bot-message';
        const typingText = lastLanguage === 'ru' ? 'набирает сообщение...' : 'typing...';
        typingIndicator.innerHTML = `<strong>${lastLanguage === 'ru' ? 'Бот' : 'Bot'}:</strong> <em>${typingText}</em>`;
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            // 1. Получаем продукты (симуляция API)
            const products = await fetchProducts();
            
            // 2. Получаем ответ ИИ
            const aiResponse = getAIResponse(userMessage, products);

            // 3. Имитируем задержку "размышлений"
            setTimeout(() => {
                document.getElementById('typing-indicator')?.remove();
                addMessage(aiResponse, 'bot');
                chatSend.disabled = false;
                isLoading = false;
                chatInput.focus();
            }, 1200);

        } catch (error) {
            console.error("Ошибка при получении ответа:", error);
            document.getElementById('typing-indicator')?.remove();
            addMessage("Произошла ошибка. Попробуйте еще раз.", 'error');
            chatSend.disabled = false;
            isLoading = false;
        }
    }

    // --- УПРАВЛЕНИЕ ИСТОРИЕЙ (localStorage) ---
    const CHAT_HISTORY_KEY = 'nutralux_chat_history';

    function saveChatHistory(message) {
        if (!message.text) return; // Не сохраняем пустые
        const history = loadChatHistory();
        history.push(message);
        localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
    }

    function loadChatHistory() {
        const history = localStorage.getItem(CHAT_HISTORY_KEY);
        return history ? JSON.parse(history) : [];
    }

    function clearChatHistory() {
        localStorage.removeItem(CHAT_HISTORY_KEY);
        chatMessages.innerHTML = '';
        // Показываем приветственное сообщение заново
        const welcomeMsg = getAIResponse("start_conversation", []);
        addMessage(welcomeMsg, 'bot');
        renderQuickReplies(['Иммунитет', 'Сон', 'Энергия']);
        clearContext();
    }
    
    // Рендерит всю историю чата из localStorage
    function renderChatFromHistory(history) {
        chatMessages.innerHTML = '';
        history.forEach(msg => {
            // Используем "тихую" версию addMessage, которая не сохраняет в историю
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.type}-message`;
            const title = document.createElement('strong');
            if (msg.type === 'user') {
                title.textContent = 'Вы: ';
                const content = document.createElement('span');
                content.textContent = msg.text;
                messageDiv.appendChild(title);
                messageDiv.appendChild(content);
            } else {
                title.textContent = 'Бот: ';
                const content = document.createElement('span');
                content.innerHTML = msg.text.replace(/\n/g, '<br>');
                messageDiv.appendChild(title);
                messageDiv.appendChild(content);
            }
            chatMessages.appendChild(messageDiv);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- УПРАВЛЕНИЕ КОНТЕКСТОМ ---
    function setContext(context) {
        currentContext = context;
    }

    function clearContext() {
        currentContext = null;
    }

    // --- ИНИЦИАЛИЗАЦИЯ СЛУШАТЕЛЕЙ ---
    if (chatFab) {
        chatFab.addEventListener('click', toggleChat);
    }
    if (chatSend && chatInput) {
        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    }
    if (chatClear) {
        chatClear.addEventListener('click', clearChatHistory);
    }
    if (chatInput) {
        chatInput.addEventListener('focus', () => {
            chatInput.placeholder = lastLanguage === 'ru' ? "Напишите ваш вопрос..." : "Type your question...";
        });
    }

</script>
